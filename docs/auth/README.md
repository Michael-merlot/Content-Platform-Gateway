# Аутентификация и авторизация

В проекте реализована поддержка динамических требований прав на эндпоинты, а так же динамические права, основанные на ролях, для пользователей.

## Структура

Есть роли (`roles`), есть права (`permissions`).
У ролей есть права (`role_permissions`).

У пользователей есть роли (`user_roles`), следовательно, права пользователя рассчитываются от его ролей.

Также есть эндпоинты (`endpoints`). Они создаются вручную (через фронтенд) на основе информации от сервера (`/api/v1/auth/endpoints/framework`). Эндпоинтам также можно назначать права, требуемые для их выполнения (`endpoint_permissions`).

Если эндпоинта в базе данных нет, то значит, что он не переопределён, и права для его выполнения берутся из атрибутов в коде (подробнее ниже). Если эндпоинт есть, то он переопределён, и данные из бд имеют высший приоритет и игнорируют то, что указано в коде.

Роли с `IsAdmin = true` игнорируют любые ограничения и всегда имеют право на выполнение любых эндпоинтов.

По умолчанию в первой миграции (`InitialCreate`) определена роль "Admin" с `IsAdmin = true`. Эта роль выдана первому пользователю (пользователю с `Id = 1`).

## Если нужен пользователь во время разработки

Если вам требуется закрытый эндпоинт, или в принципе аутентификация/авторизация, то в `appsettings.Development.json` можно указать

```cs
"Auth": {
    "UseLocalhostIssuerInDevelopment": true
}
```

и воспользоваться эндпоинтом `/api/v1/auth/issuedevtoken`, которая вернёт строкой токен для пользователя с `Id = 1`, у которого есть роль `Admin`.

## Требуемые права для эндпоинтов

Если требуется аутентфикация для эндпоинта, то метод/класс помечаете атрибутом

```cs
[Authorize]
```

> [!NOTE]
> По умолчанию права будут вычисляться из базы данных, а если их там нет, то эндпоинт считается открытым.

Для вариантов, когда нужно закрыть эндпоинты, пока они не переопределены в базе данных, могут быть использованы специальные атрибуты:

```cs
// Запрещает доступ всем, кроме администраторов, если в базе данных не хранится переопределение прав для эндпоинта
[AdminUntilDynamicAuthorize]
```

```cs
// Требует права, переданные в параметрах, если в базе данных не хранится переопределение прав для эндпоинта
// Учтите, что созданный в бд эндпоинт без назначенных ему прав, считается открытым, и является переопределением
[DefaultDynamicPermissionAuthorize(DefaultPermissions.ReadSomething, DefaultPermissions.DoNothing)]
```

> [!WARNING]
> Если создать эндпоинт в базе данных, но не назначать ему прав, то он будет **открыт всем**.
> Будьте аккуратны при назначении прав эндпоинтам через фронтенд, чтобы не допустить открытие закрытого эндпоинта даже на мгновение между обновлениями, так как это уязвимость.

Как выше можно заметить, используется класс `DefaultPermissions`. В этом классе должны храниться все объявленные по умолчанию права.
Название должно храниться в константе, а так же присутствовать в словаре.
Сам файл — `Gateway.Core/Models/Auth/DefaultPermissions.cs`.

Пример:

```cs
public const string DoNothing1 = "do.nothing1";
public const string DoNothing2 = "do.nothing2";
public const string DoNothing3 = "do.nothing3";
public const string DoNothing4 = "do.nothing4";
public const string DoNothing5 = "do.nothing5";

public static IEnumerable<Permission> GetPermissions() =>
[
    new(1, DoNothing1, "Do nothing"),
    new(2, DoNothing2, "Do nothing"),
    new(3, DoNothing3, "Do nothing"),
    new(4, DoNothing4, "Do nothing"),
    new(5, DoNothing5, "Do nothing")
];
```

> [!IMPORTANT]
> Внимательно следите за индексацией, она должна идти друг за другом и не повторяться.
> В исключительных случаях право может быть создано динамически (вне кода) и нумерация в коде съедет, но к тому моменту это уже должно быть где-то задокументировано.

После добавления права туда, потребуется создать миграцию в EF Core. **Запускать из корня репозитория, в самом конце указать название миграции**:

```shell
dotnet ef migrations add \
    -p ./Gateway.Infrastructure/Gateway.Infrastructure.csproj \
    -s ./Gateway.Api/Gateway.Api.csproj \
    -o Persistence/Auth/Migrations \
    -c AuthDbContext \
    <название миграции>
```

Право будет отражено в базе данных при миграции. Если его там не будет, а право указано с помощью `DefaultDynamicPermissionAuthorize`, то эндпоинт будет закрыт (доступен только для администраторов).
